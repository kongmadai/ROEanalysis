name: Run ROE Analysis # 工作流的名称

on:
  schedule:
    # 每周二和周四北京时间凌晨2点运行 (UTC时间周二和周三18:00)
    - cron: '0 18 * * 2,4' # 周二和周四 UTC 18:00 (对应北京时间周三和周五 2:00)
  push:
    branches: [ main ]  # 推送代码到main分支时也触发工作流（可选，用于测试）
#  pull_request:
#    branches: [ main ]  # 在main分支上创建Pull Request时触发（可选）

jobs:
  run-roe:
    runs-on: ubuntu-latest # 使用最新版本的Ubuntu运行器

    steps:
    # 1. 检出仓库代码
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # 获取所有历史记录，便于创建Release

    # 2. 设置Python环境
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' # 或者你需要的其他版本，例如'3.10'

    # 3. 安装依赖（如果你的项目有requirements.txt，这一步很重要）
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        # 如果ROE.py依赖其他库，请在此安装，例如：
        pip install akshare pandas numpy
        # 或者，如果你有requirements.txt文件：
        # pip install -r requirements.txt

    # 4. 运行你的Python脚本
    - name: Run ROE analysis
      run: |
        python code/ROEselection.py # 根据你的实际路径调整

    # 5. （可选）如果脚本生成输出文件，你可以在此步骤中上传它们作为制品(artifacts)
    - name: Upload output artifacts
      if: always() # 即使上一步失败也上传
      uses: actions/upload-artifact@v4
      with:
        name: roe-output
        path: | # 指定你的输出文件路径，例如code目录下的output.log或result.csv  这个文件会输出到artifacts的结果。文件可以是code\result.csv
          stock_analysis_results.txt

    # 6. 创建或覆盖Release（新增的核心步骤）
    - name: Create/Update Daily Release
      if: success() # 只有Python脚本成功运行时才创建Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: roe-results-$(date -u +"%Y-%m-%d")
        name: ROE分析结果 $(date -u +"%Y-%m-%d")
        files: stock_analysis_results.txt
        body: |
          自动生成的ROE股票分析结果
          
          **生成时间**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          **分析周期**: 每周*定期更新
          
          包含沪深市场ROE筛选的优质股票列表，按性价比排序。
        # overwrite: true # 允许覆盖同标签的Release
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}